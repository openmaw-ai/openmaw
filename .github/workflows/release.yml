name: Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: OpenTolk

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: echo "version=$(cat VERSION | tr -d '[:space:]')" >> $GITHUB_OUTPUT

      - name: Install Developer ID certificate
        env:
          CERTIFICATE_P12: ${{ secrets.DEVELOPER_ID_CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12

          echo -n "$CERTIFICATE_P12" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: \
            -k "" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Build universal binary
        run: swift build -c release --arch arm64 --arch x86_64

      - name: Create app bundle
        run: |
          VERSION=${{ steps.version.outputs.version }}
          APP_DIR="${APP_NAME}.app"

          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"
          mkdir -p "${APP_DIR}/Contents/Frameworks"

          BINARY=".build/apple/Products/Release/${APP_NAME}"
          if [ ! -f "$BINARY" ]; then
            BINARY=".build/release/${APP_NAME}"
          fi

          cp "$BINARY" "${APP_DIR}/Contents/MacOS/${APP_NAME}"
          cp Resources/Info.plist "${APP_DIR}/Contents/"
          cp Resources/OpenTolk.entitlements "${APP_DIR}/Contents/Resources/"
          cp Resources/PrivacyInfo.xcprivacy "${APP_DIR}/Contents/Resources/" 2>/dev/null || true

          # Bundle Sparkle framework
          SPARKLE_FRAMEWORK=$(find .build -name "Sparkle.framework" -type d 2>/dev/null | head -1)
          if [ -n "$SPARKLE_FRAMEWORK" ]; then
            cp -R "$SPARKLE_FRAMEWORK" "${APP_DIR}/Contents/Frameworks/"
            install_name_tool -add_rpath "@executable_path/../Frameworks" "${APP_DIR}/Contents/MacOS/${APP_NAME}" 2>/dev/null || true
          fi

          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${VERSION}" "${APP_DIR}/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${VERSION}" "${APP_DIR}/Contents/Info.plist"

      - name: Codesign
        env:
          DEVELOPER_ID: ${{ secrets.DEVELOPER_ID_APPLICATION }}
        run: |
          APP_DIR="${APP_NAME}.app"

          # Sign Sparkle framework
          if [ -d "${APP_DIR}/Contents/Frameworks/Sparkle.framework" ]; then
            codesign --force --options runtime \
              --sign "$DEVELOPER_ID" \
              --timestamp \
              "${APP_DIR}/Contents/Frameworks/Sparkle.framework"
          fi

          # Sign main app
          codesign --force --options runtime \
            --entitlements Resources/OpenTolk.entitlements \
            --sign "$DEVELOPER_ID" \
            --timestamp \
            "${APP_DIR}"

      - name: Create DMG
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_NAME="${APP_NAME}-${VERSION}.dmg"

          mkdir -p dmg_temp
          cp -R "${APP_NAME}.app" dmg_temp/
          ln -s /Applications dmg_temp/Applications

          hdiutil create -volname "${APP_NAME}" \
            -srcfolder dmg_temp \
            -ov -format UDZO \
            "${DMG_NAME}"
          rm -rf dmg_temp

          codesign --force --sign "${{ secrets.DEVELOPER_ID_APPLICATION }}" --timestamp "${DMG_NAME}"

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.NOTARIZE_APPLE_ID }}
          TEAM_ID: ${{ secrets.NOTARIZE_TEAM_ID }}
          APP_PASSWORD: ${{ secrets.NOTARIZE_APP_PASSWORD }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_NAME="${APP_NAME}-${VERSION}.dmg"

          xcrun notarytool submit "${DMG_NAME}" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APP_PASSWORD" \
            --wait

          xcrun stapler staple "${DMG_NAME}"

      - name: Generate appcast
        run: |
          # If Sparkle's generate_appcast is available, use it
          if command -v generate_appcast &> /dev/null; then
            generate_appcast .
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: OpenTolk v${{ steps.version.outputs.version }}
          files: |
            ${{ env.APP_NAME }}-${{ steps.version.outputs.version }}.dmg
          generate_release_notes: true
